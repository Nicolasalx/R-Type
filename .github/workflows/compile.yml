name: Compilation (Linux & Windows)
on:
  workflow_call

jobs:
  compile:
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    strategy:
      matrix:
        os: [linux, windows]

    steps:
    - uses: actions/checkout@v4

    - name: Install ccache
      run: |
        sudo apt-get update
        sudo apt-get install -y ccache

    - name: Ensure ccache directory exists
      run: |
        mkdir -p $(ccache --get-config cache_dir)

    - name: Cache ccache
      uses: actions/cache@v3
      with:
        path: $(ccache --get-config cache_dir)
        key: ccache-${{ matrix.os }}-${{ hashFiles('**/*') }}
        restore-keys: |
          ccache-${{ matrix.os }}-

    - name: Install apt dependencies (Linux)
      if: matrix.os == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y flex bison javacc libflac-dev libx11-dev libxext-dev libgl1-mesa-dev \
        libudev-dev libopenal-dev libvorbis-dev libxcursor-dev libxrandr-dev libfreetype6-dev

    - name: Cache CMake build (Linux)
      if: matrix.os == 'linux'
      uses: actions/cache@v3
      with:
        path: build/
        key: cmake-build-${{ matrix.os }}-${{ hashFiles('dependencies.cmake') }}
        restore-keys: |
          cmake-build-${{ matrix.os }}-

    - name: Check compilation (Linux)
      if: matrix.os == 'linux'
      run: |
        echo "## ðŸš€ Linux compilation result" >> $GITHUB_STEP_SUMMARY
        mkdir -p build
        cd build
        {
          set +e
          export CC="ccache gcc"
          export CXX="ccache g++"
          cmake ..; make
          if [ $? -ne 0 ]; then
            echo "- ### Compilation failed âŒ" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "- ### Compilation succeeded âœ…" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
        }

    - name: Install Mingw-w64 (Windows)
      if: matrix.os == 'windows'
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 mingw-w64-tools mingw-w64-x86-64-dev

    - name: Install ccache (Windows)
      if: matrix.os == 'windows'
      run: |
        sudo apt-get update
        sudo apt-get install -y ccache

    - name: Ensure ccache directory exists (Windows)
      if: matrix.os == 'windows'
      run: |
        mkdir -p $(ccache --get-config cache_dir)

    - name: Cache ccache (Windows)
      if: matrix.os == 'windows'
      uses: actions/cache@v3
      with:
        path: $(ccache --get-config cache_dir)
        key: ccache-${{ matrix.os }}-${{ hashFiles('**/*') }}
        restore-keys: |
          ccache-${{ matrix.os }}-

    - name: Download OpenAL Soft for Windows
      if: matrix.os == 'windows'
      run: |
        git clone https://github.com/kcat/openal-soft.git

    - name: Get OpenAL Soft commit hash
      if: matrix.os == 'windows'
      id: openal_commit_hash
      run: |
        echo "hash=$(git -C openal-soft rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Cache OpenAL Soft (Windows)
      if: matrix.os == 'windows'
      id: openal_cache
      uses: actions/cache@v3
      with:
        path: $GITHUB_WORKSPACE/openal-soft-install
        key: openal-soft-${{ matrix.os }}-${{ steps.openal_commit_hash.outputs.hash }}
        restore-keys: |
          openal-soft-${{ matrix.os }}-

    - name: Build OpenAL Soft for Windows
      if: matrix.os == 'windows' && steps.openal_cache.outputs.cache-hit != 'true'
      run: |
        cd openal-soft
        mkdir -p build
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=../../cmake/mingw32-toolchain.cmake \
                 -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/openal-soft-install \
                 -DCMAKE_BUILD_TYPE=Release
        make
        make install

    - name: Use cached OpenAL Soft (Windows)
      if: matrix.os == 'windows' && steps.openal_cache.outputs.cache-hit == 'true'
      run: |
        echo "Using cached OpenAL Soft installation"

    - name: Get source code commit hash
      if: matrix.os == 'windows'
      id: source_commit_hash
      run: |
        echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Cache cross-compilation artifacts (Windows)
      if: matrix.os == 'windows'
      uses: actions/cache@v3
      with:
        path: build-mingw32
        key: cross-build-${{ matrix.os }}-${{ steps.source_commit_hash.outputs.hash }}
        restore-keys: |
          cross-build-${{ matrix.os }}-

    - name: Cross-compile for Windows
      if: matrix.os == 'windows'
      run: |
        echo "## ðŸš€ Cross-compilation for Windows result" >> $GITHUB_STEP_SUMMARY
        chmod +x tools/build-mingw32.sh
        export CC="ccache x86_64-w64-mingw32-gcc"
        export CXX="ccache x86_64-w64-mingw32-g++"
        {
          set +e
          ./tools/build-mingw32.sh -c ON
          if [ $? -ne 0 ]; then
            echo "- ### Cross-compilation for Windows failed âŒ" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "- ### Cross-compilation succeeded âœ…" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
        }
